{% extends 'public/base_cpanel.html' %}
{% block title %}ScalIoT 游 | crear cuenta{% endblock %}
{% block body %}

<div class="container-xxl">
  <div class="authentication-wrapper authentication-basic container-p-y">
    <div class="authentication-inner">
      <div class="card">
        <div class="card-body">
          <div class="app-brand justify-content-center">
            <div class="col-md-12">
              <h3 class="text-center mt-5 mb-3">REGISTRAR USUARIO</h3>
              <hr />
            </div>
          </div>

          <form
            class="mb-3"
            action="{{ url_for('cpanelRegisterUserBD') }}"
            method="POST"
            id="registerForm"
            novalidate> <div class="mb-3">
              <label for="cedula" class="form-label">
                Cedula
              </label>
              <input
                type="text"
                class="form-control"
                name="cedula"
                required
                autofocus />
            </div>
            <div class="row">
              <div class="mb-3 col-md-6">
                <label for="name_user" class="form-label">
                  Nombre
                </label>
                <input
                  type="text"
                  class="form-control"
                  name="name"
                  required
                  autofocus />
              </div>
              <div class="mb-3 col-md-6">
                <label for="surname_user" class="form-label">
                  Apellido
                </label>
                <input
                  type="text"
                  class="form-control"
                  name="surname"
                  required
                  autofocus />
              </div>
            </div>

            <div class="mb-3">
              <label for="email_user" class="form-label">
                Email
              </label>
              <input
                type="email"
                class="form-control"
                id="email_user"
                name="email"
                placeholder="ejemplo@dominio.com"
                required />
            </div>

            <div class="mb-3">
              <label for="telefono_user" class="form-label">
                Tel칠fono
              </label>
              <input
                type="text"
                class="form-control"
                id="telefono_user"
                name="telefono"
                placeholder="Ej. 0991234567"
                required />
            </div>

            <div class="row">
              <div class="mt-3 col-md-6">
                
                
                  
                  

                </select>
              </div>
              <div class="mt-3 col-md-6" >
                <label for="rol" class="form-label">Rol</label>
                <select class="form-select" name="selectRol" id="selectRol" {%if dataLogin.rol == 2 %} disabled {%endif%}>
                  {% for rol in roles%}
                  <option value="{{rol.id_rol}}">{{rol.nombre_rol}}</option>
                  {%endfor%}
                </select>
              </div>
            </div>

            <div id="evaluadorFields" style="display: none;">
              <h5 class="mt-4 mb-3">Datos del Evaluador</h5>
              <div class="mb-3">
                <label for="especialidad" class="form-label">Especialidad</label>
                <input
                  type="text"
                  class="form-control"
                  id="especialidad"
                  name="especialidad"
                  placeholder="Ej. Psicolog칤a Infantil" />
              </div>
              <div class="mb-3">
                <label for="anos_experiencia" class="form-label">A침os de Experiencia</label>
                <input
                  type="number"
                  class="form-control"
                  id="anos_experiencia"
                  name="anos_experiencia"
                  placeholder="Ej. 5"
                  min="0" />
              </div>
              <div class="mb-3">
                <label for="certificaciones" class="form-label">Certificaciones</label>
                <textarea
                  class="form-control"
                  id="certificaciones"
                  name="certificaciones"
                  rows="3"
                  placeholder="Ej. Certificaci칩n en TEA, TDAH"></textarea>
              </div>
            </div>
            <div class="mb-3 form-password-toggle mt-3">
              <label class="form-label" for="pass_user">Clave</label>
              <div class="input-group input-group-merge">
                <input
                  type="password"
                  class="form-control"
                  name="pass_user"
                  id="pass_user"
                  placeholder="&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;"
                  aria-describedby="password"
                  required />
                <span class="input-group-text cursor-pointer">
                  <i class="bx bx-hide"></i>
                </span>
              </div>
              <div id="passwordHelp" class="form-text text-muted" style="display: none;">
                La clave debe tener al menos:
                <ul>
                  <li id="reqLength">8 caracteres de largo</li>
                  <li id="reqUppercase">Una letra may칰scula (A-Z)</li>
                  <li id="reqLowercase">Una letra min칰scula (a-z)</li>
                  <li id="reqNumber">Un n칰mero (0-9)</li>
                  <li id="reqSpecialChar">Un car치cter especial (@$!%*?&_)</li>
                </ul>
              </div>
              <div class="invalid-feedback" id="passwordFeedback" style="display: none;">
                La contrase침a no cumple con todos los requisitos.
              </div>
            </div>
            <button class="btn btn-primary w-100" type="submit">
              Crear cuenta
              <i class="bi bi-arrow-right-circle"></i>
            </button>
          </form>

          <div class="text-center">
            <a
              href="{{ url_for('usuarios') }}"
              class="d-flex align-items-center justify-content-center">
              <i class="bx bx-chevron-left scaleX-n1-rtl bx-sm"></i>
              volver
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block customJS %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectRol = document.getElementById('selectRol');
    const evaluadorFields = document.getElementById('evaluadorFields');
    const passwordInput = document.getElementById('pass_user');
    const passwordHelp = document.getElementById('passwordHelp');
    const passwordFeedback = document.getElementById('passwordFeedback');
    const registerForm = document.getElementById('registerForm');

    // Elementos de la lista de requisitos
    const reqLength = document.getElementById('reqLength');
    const reqUppercase = document.getElementById('reqUppercase');
    const reqLowercase = document.getElementById('reqLowercase');
    const reqNumber = document.getElementById('reqNumber');
    const reqSpecialChar = document.getElementById('reqSpecialChar');

    // Funci칩n para mostrar u ocultar los campos del evaluador
    function toggleEvaluadorFields() {
      if (selectRol.value === '2') {
        evaluadorFields.style.display = 'block';
        document.getElementById('especialidad').setAttribute('required', 'true');
        document.getElementById('anos_experiencia').setAttribute('required', 'true');
      } else {
        evaluadorFields.style.display = 'none';
        document.getElementById('especialidad').removeAttribute('required');
        document.getElementById('anos_experiencia').removeAttribute('required');
        document.getElementById('certificaciones').value = '';
        document.getElementById('especialidad').value = '';
        document.getElementById('anos_experiencia').value = '';
      }
    }

    // Funci칩n para validar la contrase침a y actualizar el feedback visual
    function updatePasswordRequirements() {
      const password = passwordInput.value;
      const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password),
        specialChar: /[@$!%*?&_]/.test(password)
      };

      // Actualizar el color de cada requisito
      reqLength.style.color = requirements.length ? 'green' : 'red';
      reqUppercase.style.color = requirements.uppercase ? 'green' : 'red';
      reqLowercase.style.color = requirements.lowercase ? 'green' : 'red';
      reqNumber.style.color = requirements.number ? 'green' : 'red';
      reqSpecialChar.style.color = requirements.specialChar ? 'green' : 'red';

      return Object.values(requirements).every(Boolean); // Devuelve true si todos los requisitos se cumplen
    }

    // Evento al escribir en el campo de contrase침a
    passwordInput.addEventListener('input', function() {
      updatePasswordRequirements(); // Actualiza los colores en tiempo real
      // Ocultar feedback de error mientras el usuario escribe
      passwordInput.classList.remove('is-invalid');
      passwordFeedback.style.display = 'none';
    });

    // Mostrar mensaje de ayuda y resetear feedback al enfocar el campo
    passwordInput.addEventListener('focus', function() {
      passwordHelp.style.display = 'block'; // Muestra la lista de requisitos
      updatePasswordRequirements(); // Asegura que los colores se actualicen al enfocar
      passwordInput.classList.remove('is-invalid', 'is-valid'); // Limpiar clases de validaci칩n
      passwordFeedback.style.display = 'none'; // Ocultar mensaje de error
    });

    // Ocultar mensaje de ayuda y validar al perder el foco del campo
    passwordInput.addEventListener('blur', function() {
      passwordHelp.style.display = 'none'; // Oculta la lista de requisitos
      const isValid = updatePasswordRequirements(); // Valida al perder el foco

      if (isValid) {
        passwordInput.classList.remove('is-invalid');
        passwordInput.classList.add('is-valid');
        passwordFeedback.style.display = 'none';
      } else {
        passwordInput.classList.remove('is-valid');
        passwordInput.classList.add('is-invalid');
        passwordFeedback.style.display = 'block'; // Muestra el mensaje de error de Bootstrap
      }
    });

    // Validar en el env칤o del formulario
    registerForm.addEventListener('submit', function(event) {
      const isValid = updatePasswordRequirements(); // Valida la contrase침a al intentar enviar

      if (!isValid) {
        event.preventDefault(); // Evita que el formulario se env칤e si la contrase침a no es v치lida
        passwordHelp.style.display = 'block'; // Asegura que los requisitos sean visibles si hay un error
        passwordInput.classList.add('is-invalid');
        passwordFeedback.style.display = 'block'; // Muestra el mensaje de error de Bootstrap
      } else {
        passwordInput.classList.remove('is-invalid');
        passwordInput.classList.add('is-valid');
        passwordFeedback.style.display = 'none';
      }
    });

    // Ejecutar al cargar la p치gina para establecer el estado inicial de campos de evaluador
    toggleEvaluadorFields();

    // Escuchar cambios en el selector de rol
    selectRol.addEventListener('change', toggleEvaluadorFields);
  });
</script>
{% endblock %}